{"version":3,"file":"index.js","sources":["../../src/lib/parseHeader.ts","../../src/lib/parseText.ts","../../src/lib/parseStatus.ts","../../src/Response.ts","../../src/Part.ts","../../src/Parser.ts"],"sourcesContent":["import { HeadersObject } from \"../types\";\n\nexport default function parseHeader(result: HeadersObject, line: string, delimiter: string): void {\n  const index = line.indexOf(delimiter);\n  if (index === -1) throw new Error(`Unexpected header format: ${line}`);\n  const key = line.slice(0, index);\n  const value = line.slice(index + 1);\n  result[key.trim().toLowerCase()] = value.trim();\n}\n","import newlineIterator from \"newline-iterator\";\nimport { Parser } from \"../types\";\n\nexport default function parseText(parser: Parser, text: string): void {\n  const iterator = newlineIterator(text);\n  for (const line of iterator) parser.push(line);\n  if (!parser.done()) parser.push(null);\n}\n","import { Version } from \"../types\";\n\nexport interface StatusResult {\n  version: Version;\n  ok: boolean;\n  status: number;\n  statusText: string;\n}\n\n// https://github.com/watson/http-headers/blob/master/index.js\nconst statusLine = /^[A-Z]+\\/(\\d)\\.(\\d) (\\d{3}) (.*)$/;\n\nexport default function parseStatus(result: StatusResult, line: string): boolean {\n  const match = line.match(statusLine);\n  if (!match) return false;\n\n  result.version = { major: parseInt(match[1], 10), minor: parseInt(match[2], 10) };\n  result.status = parseInt(match[3], 10);\n  result.statusText = match[4];\n  result.ok = result.statusText === \"OK\";\n  return true;\n}\n","import parseHeader from \"./lib/parseHeader\";\nimport parseStatus from \"./lib/parseStatus\";\nimport parseText from \"./lib/parseText\";\nimport type { Version, HeadersObject } from \"./types\";\n\nexport enum ParseStatus {\n  Headers = 1,\n  Body,\n}\n\nexport interface ParsingState {\n  status: ParseStatus;\n  lines: string[];\n}\n\nexport default class MultipartResponse {\n  version: Version;\n  headers: HeadersObject = {};\n  ok: boolean;\n  status: number;\n  statusText: string;\n  body: string = null;\n\n  // bodyUsed: boolean;\n  // redirected: boolean;\n  // trailer: Promise<Headers>;\n  // type: ResponseType;\n  // url: string;\n\n  private _parsingState: ParsingState | null = {\n    status: ParseStatus.Headers,\n    lines: [],\n  };\n\n  done(): boolean {\n    return !this._parsingState;\n  }\n\n  parse(text: string): void {\n    parseText(this, text);\n  }\n\n  push(line: string): void {\n    if (!this._parsingState) throw new Error(\"Attempting to parse a completed response\");\n    if (line === null) {\n      if (this._parsingState.status !== ParseStatus.Body) throw new Error(\"Unexpected parsing state\");\n      this.body = this._parsingState.lines.join(\"\\r\\n\");\n      this._parsingState = null;\n      return;\n    }\n\n    if (this._parsingState.status === ParseStatus.Headers) {\n      if (!line.length) this._parsingState.status = ParseStatus.Body;\n      else if (!parseStatus(this, line)) parseHeader(this.headers, line, \":\");\n    } else if (this._parsingState.status === ParseStatus.Body) {\n      if (!line.length) this.push(null);\n      else this._parsingState.lines.push(line);\n    }\n  }\n\n  text(): string {\n    if (this._parsingState) throw new Error(\"Attempting to use an incomplete response\");\n    return this.body;\n  }\n\n  json(): unknown {\n    if (this._parsingState) throw new Error(\"Attempting to use an incomplete response\");\n    if (this.headers[\"content-type\"].indexOf(\"application/json\") === -1) {\n      throw new Error(`Not json response. Content type: ${this.headers[\"content-type\"]}`);\n    }\n    return JSON.parse(this.body);\n  }\n}\n","import parseHeader from \"./lib/parseHeader\";\nimport parseText from \"./lib/parseText\";\nimport MultipartResponse from \"./Response\";\nimport type { HeadersObject } from \"./types\";\n\nexport enum ParseStatus {\n  Headers = 1,\n  Response,\n}\n\nexport interface ParsingState {\n  status: ParseStatus;\n}\n\nexport default class MultipartPart {\n  headers: HeadersObject = {};\n  response: MultipartResponse = new MultipartResponse();\n\n  private _parsingState: ParsingState | null = {\n    status: ParseStatus.Headers,\n  };\n\n  done(): boolean {\n    return !this._parsingState;\n  }\n\n  parse(text: string): void {\n    parseText(this, text);\n  }\n\n  push(line: string): void {\n    if (!this._parsingState) throw new Error(\"Attempting to parse a completed part\");\n    if (line === null) {\n      if (this._parsingState.status !== ParseStatus.Response) throw new Error(\"Unexpected parsing state\");\n      if (!this.response.done()) this.response.push(null);\n      this._parsingState = null;\n      return;\n    }\n\n    if (this._parsingState.status === ParseStatus.Headers) {\n      if (!line.length) {\n        if (this.headers[\"content-type\"] !== \"application/http\")\n          throw new Error(`Unexpected content type: ${this.headers[\"content-type\"]}`);\n        this._parsingState.status = ParseStatus.Response;\n      } else parseHeader(this.headers, line, \":\");\n    } else if (this._parsingState.status === ParseStatus.Response) {\n      this.response.push(line);\n    }\n  }\n}\n","import Part from \"./Part\";\nimport parseHeader from \"./lib/parseHeader\";\nimport parseText from \"./lib/parseText\";\nimport type { HeadersObject } from \"./types\";\n\nexport enum ParseStatus {\n  Parts = 1,\n}\n\nexport interface ParsingState {\n  status: ParseStatus;\n  boundaryEnd: string | null;\n}\n\nexport default class MultipartParser {\n  type: string;\n  headers: HeadersObject = {};\n  parts: Part[] = [];\n\n  private _parsingState: ParsingState | null = {\n    status: ParseStatus.Parts,\n    boundaryEnd: null,\n  };\n  private boundary: string | null = null;\n\n  constructor(headers: Headers | string | HeadersObject) {\n    if (!headers) throw new Error(\"Headers missing\");\n\n    let contentType: string;\n    if (typeof headers === \"string\") contentType = headers;\n    /* c8 ignore start */ else if (headers.get) contentType = (headers as Headers).get(\"content-type\");\n    /* c8 ignore stop */ else contentType = (headers as HeadersObject)[\"content-type\"];\n    if (!contentType) throw Error(\"content-type header not found\");\n\n    const parts = contentType.split(/;/g);\n    this.type = parts.shift().trim();\n    if (this.type.indexOf(\"multipart\") !== 0) {\n      throw new Error(`Expecting a multipart type. Received: ${contentType}`);\n    }\n    for (const part of parts) parseHeader(this.headers, part, \"=\");\n\n    // boundary\n    if (!this.headers.boundary) throw new Error(\"Invalid Content Type: no boundary\");\n    this.boundary = `--${this.headers.boundary}`;\n    this._parsingState.boundaryEnd = `--${this.headers.boundary}--`;\n    this._parsingState.status = ParseStatus.Parts;\n  }\n\n  done(): boolean {\n    return !this._parsingState;\n  }\n\n  parse(text: string): void {\n    parseText(this, text);\n  }\n\n  push(line: string): void {\n    const part = this.parts.length ? this.parts[this.parts.length - 1] : null;\n\n    if (!this._parsingState) throw new Error(\"Attempting to parse a completed multipart\");\n    if (line === null) {\n      if (part && !part.done()) part.push(null);\n      this._parsingState = null;\n      return;\n    }\n\n    if (line === this._parsingState.boundaryEnd) this.push(null);\n    else if (line === this.boundary) {\n      if (part && !part.done()) part.push(null);\n      this.parts.push(new Part());\n    } else if (part) part.push(line);\n    else {\n      if (line.length) throw new Error(`Unexpected line: ${line}`);\n    }\n  }\n}\n"],"names":["parseHeader","result","line","delimiter","index","indexOf","Error","key","slice","value","trim","toLowerCase","parseText","parser","text","iterator","newlineIterator","push","done","statusLine","parseStatus","match","version","major","parseInt","minor","status","statusText","ok","ParseStatus","MultipartResponse","headers","body","_parsingState","Headers","lines","parse","Body","join","length","json","JSON","MultipartPart","response","Response","MultipartParser","parts","Parts","boundaryEnd","boundary","constructor","contentType","get","split","type","shift","part","Part"],"mappings":"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"}